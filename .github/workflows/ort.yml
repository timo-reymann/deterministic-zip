name: ORT License Compliance

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  ort:
    name: OSS Review Toolkit
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/oss-review-toolkit/ort
      options: --user 0:0
    steps:
       - name: Checkout
         uses: actions/checkout@v4

       - name: Cache dependencies
         id: cache-dependencies
         uses: actions/cache@v4
         with:
           path: |
             ~/.cabal/packages
             ~/.cabal/store
             ~/.cache/go-build
             ~/.cache/pip
             ~/.cache/yarn
             ~/.cargo/bin/
             ~/.cargo/registry/index/
             ~/.cargo/registry/cache/
             ~/.cargo/git/db/
             ~/.composer
             ~/.gradle/caches
             ~/.gradle/wrapper
             ~/.ivy2/cache
             ~/.local/share/virtualenvs
             ~/.m2/repository
             ~/.npm
             ~/.nuget/packages
             !~/.nuget/packages/unwanted
             ~/.sbt
             ~/.stack-work
             ~/go/pkg/mod
             $HOME/$ORT_HOME_PATH/cache
           key: ort-deps-cache

       - name: Cache ORT
         id: cache-ort
         uses: actions/cache@v4
         with:
           path: '~/.ort'
           key: ort-cache

       - name: Prepare directories
         run: |
           mkdir -p ort/analyze ort/scanner ort/evaluation ort/report

       - name: Analyze
         run: |
           ort -c .ort/config.yml analyze -i . -o ort/analyze

       - name: Scan
         run: |
           ort -c .ort/config.yml scan -i ort/analyze/analyzer-result.yml -o ort/scanner

       - name: Evaluate
         id: evaluate
         run: |
           ort -c .ort/config.yml evaluate \
             --rules-file .ort/evaluator.rules.kts \
             --license-classifications-file .ort/license-classifications.yml \
             -i ort/scanner/scan-result.yml \
             -o ort/evaluation

       - name: Report
         if: always() && steps.evaluate.outcome != 'skipped'
         run: |
           ort -c .ort/config.yml report \
             -i ort/evaluation/evaluation-result.yml \
             -o ort/report \
             --report-formats PlainTextTemplate,StaticHtml,WebApp

       - name: Upload reports
         if: always() && steps.evaluate.outcome != 'skipped'
         uses: actions/upload-artifact@v4
         with:
           name: ort-reports
           path: ort/report/